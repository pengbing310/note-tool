<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub备忘录 - 初始配置</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .config-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }
        
        .config-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .config-header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .config-header p {
            color: #7f8c8d;
            font-size: 1.1rem;
        }
        
        .config-steps {
            display: grid;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .config-step {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border-left: 4px solid #3498db;
        }
        
        .config-step h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .config-step-content {
            display: grid;
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .form-hint {
            display: block;
            margin-top: 8px;
            color: #7f8c8d;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .form-hint a {
            color: #3498db;
            text-decoration: none;
        }
        
        .form-hint a:hover {
            text-decoration: underline;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
            border: 1px solid #ddd;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .config-warning {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .config-warning h4 {
            color: #c53030;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .token-generator {
            background: #f0f7ff;
            border: 1px solid #c3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .token-generator ul {
            margin: 10px 0 10px 20px;
        }
        
        .token-generator li {
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .local-option {
            background: #f8fff0;
            border: 1px solid #d4edda;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .local-option h4 {
            color: #28a745;
            margin-bottom: 10px;
        }
        
        /* 导入配置样式 */
        .import-section {
            background: #f0f7ff;
            border: 2px dashed #3498db;
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
            text-align: center;
        }
        
        .import-section h4 {
            color: #3498db;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .import-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .config-container {
                margin: 20px;
                padding: 25px;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .import-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="config-container">
        <!-- 头部 -->
        <div class="config-header">
            <h1><i class="fas fa-book"></i> GitHub备忘录工具</h1>
            <p>首次使用，请完成以下配置</p>
        </div>

        <!-- 导入配置区域 -->
        <div class="import-section">
            <h4><i class="fas fa-download"></i> 已有配置？一键导入</h4>
            <p>如果您已有配置链接，可以直接导入：</p>
            
            <div class="form-group">
                <input type="text" id="importLink" class="form-control" 
                       placeholder="粘贴配置链接或扫描二维码">
            </div>
            
            <div class="import-actions">
                <button id="importConfigBtn" class="btn btn-primary">
                    <i class="fas fa-file-import"></i> 导入配置
                </button>
                <button id="scanQRBtn" class="btn btn-secondary">
                    <i class="fas fa-qrcode"></i> 扫描二维码
                </button>
            </div>
        </div>

        <!-- 配置步骤 -->
        <div class="config-steps">
            <!-- 步骤1：GitHub配置 -->
            <div class="config-step">
                <h3><i class="fab fa-github"></i> 第一步：GitHub配置</h3>
                <div class="config-step-content">
                    <div class="form-group">
                        <label for="githubUsername">GitHub用户名 *</label>
                        <input type="text" id="githubUsername" class="form-control" 
                               placeholder="请输入您的GitHub用户名" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="repoName">仓库名称 *</label>
                        <input type="text" id="repoName" class="form-control" 
                               placeholder="例如：memo-data" value="memo-data" required>
                        <span class="form-hint">
                            如果仓库不存在，将自动创建。建议使用私有仓库。
                        </span>
                    </div>
                    
                    <div class="form-group">
                        <label for="githubToken">Personal Access Token *</label>
                        <input type="password" id="githubToken" class="form-control" 
                               placeholder="输入GitHub Token" required>
                        <span class="form-hint">
                            需要 <code>repo</code> 权限（Full control of private repositories）。
                            <a href="https://github.com/settings/tokens/new" target="_blank">
                                <i class="fas fa-external-link-alt"></i> 点击这里生成Token
                            </a>
                        </span>
                        
                        <div class="token-generator">
                            <strong>Token生成步骤：</strong>
                            <ul>
                                <li>登录GitHub，访问设置 → Developer settings → Personal access tokens</li>
                                <li>点击 "Generate new token"</li>
                                <li>选择 "repo" 权限</li>
                                <li>点击 "Generate token"</li>
                                <li>复制生成的Token（只会显示一次）</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 步骤2：存储选项 -->
            <div class="config-step">
                <h3><i class="fas fa-database"></i> 第二步：存储选项</h3>
                <div class="config-step-content">
                    <div class="form-group">
                        <label>数据存储方式</label>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <label style="display: flex; align-items: flex-start; gap: 10px;">
                                <input type="radio" name="storageType" value="github" checked>
                                <div>
                                    <strong>GitHub云端存储（推荐）</strong>
                                    <div class="form-hint">
                                        数据保存到GitHub仓库，可在多设备间同步
                                    </div>
                                </div>
                            </label>
                            
                            <label style="display: flex; align-items: flex-start; gap: 10px;">
                                <input type="radio" name="storageType" value="local">
                                <div>
                                    <strong>本地浏览器存储</strong>
                                    <div class="form-hint">
                                        数据仅保存在当前浏览器，无法同步
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 本地存储选项 -->
        <div class="local-option hidden" id="localOption">
            <h4><i class="fas fa-info-circle"></i> 本地存储说明</h4>
            <p>选择本地存储模式：</p>
            <ul style="margin: 10px 0 10px 20px;">
                <li>所有数据仅保存在您的浏览器中</li>
                <li>不会上传到GitHub，完全私密</li>
                <li>无法在不同设备间同步</li>
                <li>清除浏览器数据会丢失备忘录</li>
                <li>建议定期导出备份</li>
            </ul>
            <button type="button" id="useLocalBtn" class="btn btn-primary">
                <i class="fas fa-check"></i> 使用本地存储
            </button>
        </div>

        <!-- 警告信息 -->
        <div class="config-warning">
            <h4><i class="fas fa-exclamation-triangle"></i> 重要安全提示</h4>
            <p>
                <strong>Token安全：</strong>您的GitHub Token会加密存储在浏览器本地，不会被发送到其他服务器。
                请妥善保管您的Token，不要分享给他人。如果Token泄露，请立即在GitHub上撤销。
            </p>
            <p style="margin-top: 10px;">
                <strong>数据隐私：</strong>如果您使用私有仓库，只有您能看到备忘录内容。
                如果使用公开仓库，任何人都能通过GitHub看到您的数据。
            </p>
        </div>

        <!-- 操作按钮 -->
        <div class="form-actions">
            <button id="saveConfigBtn" class="btn btn-primary">
                <i class="fas fa-save"></i> 保存配置并开始使用
            </button>
            <button id="testConfigBtn" class="btn btn-secondary">
                <i class="fas fa-wifi"></i> 测试连接
            </button>
        </div>
    </div>

    <script>
        class ConfigManager {
            constructor() {
                this.initElements();
                this.bindEvents();
                
                // 检查URL参数
                this.checkUrlParams();
            }
            
            initElements() {
                this.githubUsername = document.getElementById('githubUsername');
                this.repoName = document.getElementById('repoName');
                this.githubToken = document.getElementById('githubToken');
                this.saveConfigBtn = document.getElementById('saveConfigBtn');
                this.testConfigBtn = document.getElementById('testConfigBtn');
                this.storageTypeRadios = document.querySelectorAll('input[name="storageType"]');
                this.localOption = document.getElementById('localOption');
                this.useLocalBtn = document.getElementById('useLocalBtn');
                this.importLink = document.getElementById('importLink');
                this.importConfigBtn = document.getElementById('importConfigBtn');
                this.scanQRBtn = document.getElementById('scanQRBtn');
            }
            
            bindEvents() {
                this.saveConfigBtn.addEventListener('click', () => this.saveConfig());
                this.testConfigBtn.addEventListener('click', () => this.testConnection());
                this.useLocalBtn.addEventListener('click', () => this.useLocalStorage());
                this.importConfigBtn.addEventListener('click', () => this.importConfigFromLink());
                
                // 监听存储方式变化
                this.storageTypeRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.localOption.classList.toggle('hidden', e.target.value !== 'local');
                    });
                });
            }
            
            checkUrlParams() {
                const params = new URLSearchParams(window.location.search);
                
                // 检查是否有配置链接
                const configParam = params.get('config');
                if (configParam) {
                    this.importConfigFromURL(configParam);
                    return;
                }
                
                // 检查是否有基础参数
                const user = params.get('user');
                const repo = params.get('repo');
                
                if (user) {
                    this.githubUsername.value = user;
                }
                
                if (repo) {
                    this.repoName.value = repo;
                }
            }
            
            importConfigFromURL(encodedConfig) {
                try {
                    const decoded = decodeURIComponent(encodedConfig);
                    const config = JSON.parse(decoded);
                    
                    if (config.username && config.repo && config.token) {
                        // 填充表单
                        this.githubUsername.value = config.username;
                        this.repoName.value = config.repo;
                        this.githubToken.value = config.token;
                        
                        // 设置存储类型
                        if (config.storageType) {
                            const radios = document.querySelectorAll('input[name="storageType"]');
                            radios.forEach(radio => {
                                if (radio.value === config.storageType) {
                                    radio.checked = true;
                                    radio.dispatchEvent(new Event('change'));
                                }
                            });
                        }
                        
                        alert('配置已从URL导入！');
                    }
                } catch (error) {
                    console.error('URL配置解析失败:', error);
                    alert('配置导入失败，请检查链接是否正确');
                }
            }
            
            importConfigFromLink() {
                const link = this.importLink.value.trim();
                if (!link) {
                    alert('请输入配置链接');
                    return;
                }
                
                try {
                    // 尝试从链接中提取配置参数
                    const url = new URL(link);
                    const params = new URLSearchParams(url.search);
                    const configParam = params.get('config');
                    
                    if (configParam) {
                        this.importConfigFromURL(configParam);
                        this.importLink.value = '';
                    } else {
                        alert('链接中未找到配置信息');
                    }
                } catch (error) {
                    // 如果不是完整URL，尝试直接解析
                    if (link.startsWith('{')) {
                        try {
                            const config = JSON.parse(link);
                            const encoded = encodeURIComponent(JSON.stringify(config));
                            this.importConfigFromURL(encoded);
                            this.importLink.value = '';
                        } catch (parseError) {
                            alert('配置格式错误，请检查链接');
                        }
                    } else {
                        alert('请提供有效的配置链接');
                    }
                }
            }
            
            async testConnection() {
                const config = this.getConfig();
                
                if (!config.username || !config.repo || !config.token) {
                    alert('请先填写所有配置信息');
                    return;
                }
                
                try {
                    // 测试GitHub API连接
                    const response = await fetch(`https://api.github.com/repos/${config.username}/${config.repo}`, {
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (response.ok) {
                        const repoInfo = await response.json();
                        alert(`✅ 连接成功！\n仓库: ${repoInfo.full_name}\n权限: ${repoInfo.private ? '私有' : '公开'}`);
                    } else if (response.status === 404) {
                        if (confirm('仓库不存在，是否要创建这个仓库？')) {
                            await this.createRepository(config);
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    alert(`❌ 连接失败: ${error.message}\n\n请检查：\n1. Token是否正确\n2. Token是否有repo权限\n3. 网络连接是否正常`);
                }
            }
            
            async createRepository(config) {
                try {
                    const response = await fetch('https://api.github.com/user/repos', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${config.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            name: config.repo,
                            description: 'GitHub备忘录数据存储',
                            private: true, // 默认创建私有仓库
                            auto_init: true // 初始化README
                        })
                    });
                    
                    if (response.ok) {
                        alert('✅ 仓库创建成功！');
                    } else {
                        const error = await response.json();
                        throw new Error(error.message || '创建失败');
                    }
                } catch (error) {
                    alert(`❌ 创建仓库失败: ${error.message}`);
                }
            }
            
            getConfig() {
                const storageType = document.querySelector('input[name="storageType"]:checked').value;
                
                return {
                    username: this.githubUsername.value.trim(),
                    repo: this.repoName.value.trim() || 'memo-data',
                    token: this.githubToken.value.trim(),
                    storageType: storageType,
                    configuredAt: new Date().toISOString()
                };
            }
            
            async saveConfig() {
                const config = this.getConfig();
                
                // 验证输入
                if (config.storageType === 'github') {
                    if (!config.username) {
                        alert('请输入GitHub用户名');
                        return;
                    }
                    if (!config.token) {
                        alert('请输入GitHub Token');
                        return;
                    }
                    if (config.token.length < 20) {
                        alert('Token格式不正确，请检查');
                        return;
                    }
                }
                
                // 加密保存配置（简单base64编码）
                const encryptedConfig = {
                    ...config,
                    // Token仅存储，不显示
                    token: config.token ? btoa(config.token) : ''
                };
                
                // 保存到localStorage
                localStorage.setItem('githubMemoConfig', JSON.stringify(encryptedConfig));
                
                // 跳转到主页面
                window.location.href = 'index.html';
            }
            
            useLocalStorage() {
                // 保存本地存储配置
                const config = {
                    username: '',
                    repo: 'memo-data',
                    token: '',
                    storageType: 'local',
                    configuredAt: new Date().toISOString()
                };
                
                localStorage.setItem('githubMemoConfig', JSON.stringify(config));
                window.location.href = 'index.html';
            }
        }
        
        // 初始化配置管理器
        document.addEventListener('DOMContentLoaded', function() {
            const configManager = new ConfigManager();
        });
    </script>
</body>
</html>